{% extends 'base.html' %}

{% block content %}
    <link rel="stylesheet" href="{{ url_for('static', filename='form.css') }}">
    <div class="container">
        <h1>Главная страница</h1>
        <form method="post" action="" class="form" id="form">
            <label for="url">Ссылка задания</label>
            <input type="text" name="url" id="url" required pattern="^https://edu\.skysmart\.ru/student/[a-zA-Z]{10}$" title="Неа, это не ссылка на скайсмарт задание">
            <label for="score">На сколько баллов</label>
            <input type="number" name="score" id="score" required min="0" max="100">
            <input type="submit" value="Решить">
            <p id="state" style="display: none"></p>
        </form>
        <a href="/setauth">Изменить данные</a>
    </div>
    <script>
        const errors = {
            'autherror': 'Неправильный логин или пароль',
            'notexist': 'Ссылка ведет на несуществующую задачу'
        }

        async function handleSubmit(ev) {
            ev.preventDefault();
            stateHolder.style.display = 'unset';

            stateHolder.innerText = "Ожидание сервера...";
            const formdata = new FormData(ev.target);
            const url = formdata.get('url');
            const score = formdata.get('score');

            const resp = await fetch(
                '/maker', {
                    method: 'post',
                    body: JSON.stringify({url, score}),
                    headers: {'Content-Type': 'application/json'},
                });

            const reader = resp.body.getReader();

            while (true) {
                const {value} = await reader.read();
                const raw_text = new TextDecoder().decode(value);
                const messages = raw_text.split('|');
                let last_msg = messages.slice(-1)[0];  // If there are multiple messages read at once, get last one
                const done = last_msg.startsWith('end');
                if (done) {
                    last_msg = errors[last_msg.split(':').slice(-1)[0]];
                }
                stateHolder.innerText = last_msg;
                if (done) break;
            }
        }

        const form = document.getElementsByTagName('form')[0];
        const stateHolder = document.getElementById('state');

        form.addEventListener('submit', handleSubmit)
    </script>
{% endblock %}